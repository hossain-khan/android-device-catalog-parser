name: Update Device Catalog Snapshots

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: 'PR title (optional)'
        required: false
        default: 'Update device catalog snapshots'

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          npm install -g ajv-cli

      - name: Grant execute permissions to scripts
        run: |
          chmod +x gradlew
          chmod +x minify-json.sh
          chmod +x copy-resources.sh
          chmod +x copy-to-catalog-data.sh

      - name: Generate JSON files
        run: |
          # Run the sample application to generate JSON files
          # Note: The JSON generation code is enabled by default in Main.kt
          ./gradlew :sample:run

      - name: Minify JSON files
        run: ./minify-json.sh

      - name: Copy resources to test directory
        run: ./copy-resources.sh

      - name: Copy resources to catalog-data directory
        run: ./copy-to-catalog-data.sh

      - name: Validate catalog metadata JSON
        run: |
          echo "Validating catalog-metadata.json against schema..."
          if ajv validate -s catalog-data/catalog-metadata-schema.json -d catalog-data/catalog-metadata.json --strict=false; then
            echo "‚úÖ catalog-metadata.json is valid according to schema"
          else
            echo "‚ùå ERROR: catalog-metadata.json validation failed!"
            exit 1
          fi

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update device catalog snapshots
            
            - Regenerated JSON files from latest CSV catalog
            - Updated minified versions
            - Synced test resources
            - Added catalog-data directory with public files
            - Generated catalog metadata JSON
          branch: update-catalog-${{ steps.date.outputs.date }}
          delete-branch: true
          title: ${{ inputs.pr_title || 'Update device catalog snapshots' }}
          body: |
            ## ü§ñ Automated Device Catalog Update
            
            This PR updates the device catalog snapshot files with the latest data.
            
            ### Changes Made
            - ‚úÖ Regenerated `android-devices-catalog.json` from CSV
            - ‚úÖ Regenerated `android-devices-catalog-unfiltered.json` from CSV  
            - ‚úÖ Created minified versions of both JSON files
            - ‚úÖ Copied all resources to `lib/src/test/resources/` for testing
            - ‚úÖ Copied all resources to `catalog-data/` for public access
            - ‚úÖ Generated catalog metadata with export date and record counts
            
            ### Generated Files
            
            **Sample resources:**
            - `sample/src/main/resources/android-devices-catalog.json`
            - `sample/src/main/resources/android-devices-catalog-unfiltered.json`
            - `sample/src/main/resources/android-devices-catalog.min.json`
            - `sample/src/main/resources/android-devices-catalog-unfiltered.min.json`
            
            **Test resources:**
            - `lib/src/test/resources/android-devices-catalog.json`
            - `lib/src/test/resources/android-devices-catalog-unfiltered.json`
            - `lib/src/test/resources/android-devices-catalog.min.json`
            - `lib/src/test/resources/android-devices-catalog-unfiltered.min.json`
            - `lib/src/test/resources/android-devices-catalog.csv`
            
            **Public catalog data:**
            - `catalog-data/android-devices-catalog.json`
            - `catalog-data/android-devices-catalog-unfiltered.json`
            - `catalog-data/android-devices-catalog.min.json`
            - `catalog-data/android-devices-catalog-unfiltered.min.json`
            - `catalog-data/android-devices-catalog.csv`
            - `catalog-data/catalog-metadata.json`
            
            ### Workflow Run
            - **Triggered by**: @${{ github.actor }}
            - **Date**: ${{ steps.date.outputs.date }}
            - **Workflow**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            **Please review the changes and merge if everything looks good.**
          labels: |
            automated
            data-update
          reviewers: ${{ github.actor }}

      - name: No changes detected
        if: steps.git-check.outputs.has_changes != 'true'
        run: |
          echo "‚ÑπÔ∏è  No changes detected in device catalog files."
          echo "The generated files are identical to the existing ones."
